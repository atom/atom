jobs:
  - job: Linux
    dependsOn: GetReleaseVersion
    timeoutInMinutes: 180
    variables:
      ReleaseVersion: $[ dependencies.GetReleaseVersion.outputs['Version.ReleaseVersion'] ]
    pool:
      # This image is used to host the Docker container that runs the build
      vmImage: ubuntu-16.04
    container: ubuntu:trusty

    steps:
      - template: templates/preparation.yml

      - template: templates/cache.yml
        parameters:
          OS: linux

      - template: templates/bootstrap.yml

      - script: script/lint
        displayName: Run linter

      - template: templates/linux-build.yml

      - template: templates/linux-test.yml

      - template: templates/publish.yml
        parameters:
          artifacts:
            - filename: atom.x86_64.rpm
              dir: $(Build.SourcesDirectory)/out
              condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
            - filename: atom-amd64.deb
              dir: $(Build.SourcesDirectory)/out
              condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
            - filename: atom-amd64.tar.gz
              dir: $(Build.SourcesDirectory)/out
              condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
