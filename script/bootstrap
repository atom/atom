#!/usr/bin/env node
var safeExec = require('./utils/child-process-wrapper.js').safeExec;
var path = require('path');

// OAuth token for atom-bot
// TODO Remove once all repositories are public
if (!process.env.ATOM_ACCESS_TOKEN)
  process.env.ATOM_ACCESS_TOKEN = '362295be4c5258d3f7b967bbabae662a455ca2a7';

// Executes an array of commands one by one.
function executeCommands(commands, done, index) {
  index = (index == undefined ? 0 : index);
  if (index < commands.length) {
    var command = commands[index];
    var options = null;
    if (typeof command !== 'string') {
      options = command.options;
      command = command.command;
    }
    safeExec(command, options, executeCommands.bind(this, commands, done, index + 1));
  } else
    done(null);
}

var echoNewLine = process.platform == 'win32' ? 'echo.' : 'echo';
var commands = [
  'git submodule --quiet sync',
  'git submodule --quiet update --recursive --init',
  {command: 'npm install --silent'), options: {cwd: path.resolve(__dirname, '..', 'vendor', 'apm'), ignoreStdout: true}},
  {command: 'npm install --silent vendor/apm', options: {ignoreStdout: true}},
  echoNewLine,
  'node node_modules/atom-package-manager/bin/apm clean',
  'node node_modules/atom-package-manager/bin/apm install --silent',
];

process.chdir(path.dirname(__dirname));
executeCommands(commands, process.exit);
