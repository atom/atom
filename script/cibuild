#!/usr/bin/env node
var cp = require('./utils/child-process-wrapper.js');
var fs = require('fs');
var path = require('path');

process.chdir(path.dirname(__dirname));

if (process.platform != 'darwin')
  throw new Error('cibuild can not run on ' + process.platform + ' yet!');

var homeDir = process.platform == 'win32' ? process.env.USERPROFILE : process.env.HOME;

function readEnvironmentVariables() {
  var credentialsPath = '/var/lib/jenkins/config/atomcredentials';
  try {
    var credentials = fs.readFileSync(credentialsPath, 'utf8');
    var lines = credentials.trim().split('\n');
    for (i in lines) {
      var parts = lines[i].split('=');
      var key = parts[0].trim();
      var value = parts[1].trim().substr(1, parts[1].length - 2);
      process.env[key] = value;
    }
  } catch(error) { }
}

readEnvironmentVariables();
cp.safeExec.bind(global, 'node script/bootstrap', function(error) {
  if (error)
    process.exit(1);
  var async = require('async');
  async.series([
    require('rimraf').bind(global, path.join(homeDir, '.atom')),
    cp.safeExec.bind(global, 'git clean -dff'),
    cp.safeExec.bind(global, 'node node_modules/grunt-cli/bin/grunt ci --stack --no-color'),
  ], function(error) {
    process.exit(error ? 1 : 0);
  });
})();
